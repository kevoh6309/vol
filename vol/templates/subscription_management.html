{% extends 'base.html' %}
{% block title %}Subscription Management - ResumeBuilder Pro{% endblock %}
{% block content %}
<div class="container-fluid py-4">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card border-0 shadow-sm">
                <div class="card-body p-4">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h1 class="h2 mb-1">
                                <i class="bi bi-credit-card text-primary me-2"></i>
                                Subscription Management
                            </h1>
                            <p class="text-muted mb-0">Manage your subscription, view usage, and handle billing</p>
                        </div>
                        <div class="text-end">
                            <div class="badge bg-{{ 'success' if subscription.is_premium else 'secondary' }} fs-6 px-3 py-2">
                                <i class="bi bi-{{ 'star-fill' if subscription.is_premium else 'person' }} me-1"></i>
                                {{ subscription.current_plan.name }} Plan
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Current Plan Overview -->
    <div class="row mb-4">
        <div class="col-lg-8">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-transparent border-0">
                    <h5 class="mb-0">
                        <i class="bi bi-info-circle me-2"></i>
                        Current Plan
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row align-items-center">
                        <div class="col-md-6">
                            <h4 class="mb-2">{{ subscription.current_plan.name }} Plan</h4>
                            <h2 class="text-primary mb-3">{{ subscription.current_plan.price }}</h2>
                            <div class="mb-3">
                                <span class="badge bg-{{ 'success' if subscription.current_plan.status == 'Active' else 'warning' }} me-2">
                                    {{ subscription.current_plan.status }}
                                </span>
                                {% if subscription.current_plan.days_remaining > 0 %}
                                <span class="text-muted">{{ subscription.current_plan.days_remaining }} days remaining</span>
                                {% endif %}
                            </div>
                            {% if subscription.current_plan.expiry_date %}
                            <p class="text-muted mb-0">
                                <i class="bi bi-calendar me-1"></i>
                                Expires: {{ subscription.current_plan.expiry_date }}
                            </p>
                            {% endif %}
                        </div>
                        <div class="col-md-6">
                            <div class="d-grid gap-2">
                                {% if subscription.can_upgrade %}
                                <button class="btn btn-primary btn-lg" onclick="upgradePlan()">
                                    <i class="bi bi-arrow-up-circle me-2"></i>
                                    Upgrade to Premium
                                </button>
                                {% endif %}
                                {% if subscription.can_downgrade %}
                                <button class="btn btn-outline-danger" onclick="cancelSubscription()">
                                    <i class="bi bi-x-circle me-2"></i>
                                    Cancel Subscription
                                </button>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-lg-4">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-transparent border-0">
                    <h5 class="mb-0">
                        <i class="bi bi-list-check me-2"></i>
                        Plan Features
                    </h5>
                </div>
                <div class="card-body">
                    <ul class="list-unstyled mb-0">
                        {% for feature in subscription.current_plan.features %}
                        <li class="mb-2">
                            <i class="bi bi-check-circle text-success me-2"></i>
                            {{ feature }}
                        </li>
                        {% endfor %}
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <!-- Usage Statistics -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-transparent border-0">
                    <h5 class="mb-0">
                        <i class="bi bi-graph-up me-2"></i>
                        Usage Statistics
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-3 text-center mb-3">
                            <div class="metric-highlight">
                                <div class="metric-value">{{ usage.total_resumes }}</div>
                                <div class="metric-label">Total Resumes</div>
                            </div>
                        </div>
                        <div class="col-md-3 text-center mb-3">
                            <div class="metric-highlight">
                                <div class="metric-value">{{ usage.total_applications }}</div>
                                <div class="metric-label">Applications</div>
                            </div>
                        </div>
                        <div class="col-md-3 text-center mb-3">
                            <div class="metric-highlight">
                                <div class="metric-value">{{ usage.total_downloads }}</div>
                                <div class="metric-label">Downloads</div>
                            </div>
                        </div>
                        <div class="col-md-3 text-center mb-3">
                            <div class="metric-highlight">
                                <div class="metric-value">{{ usage.storage_used }}MB</div>
                                <div class="metric-label">Storage Used</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row mt-4">
                        <div class="col-md-6">
                            <h6>Monthly Activity:</h6>
                            <div class="d-flex justify-content-between mb-2">
                                <span>Resumes Created</span>
                                <span class="badge bg-primary">{{ usage.monthly_resumes }}</span>
                            </div>
                            <div class="d-flex justify-content-between mb-2">
                                <span>Applications Submitted</span>
                                <span class="badge bg-success">{{ usage.monthly_applications }}</span>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <h6>API Usage:</h6>
                            <div class="d-flex justify-content-between mb-2">
                                <span>AI Analysis</span>
                                <span class="badge bg-info">{{ usage.api_calls.ai_analysis }}</span>
                            </div>
                            <div class="d-flex justify-content-between mb-2">
                                <span>Total API Calls</span>
                                <span class="badge bg-warning">{{ usage.api_calls.total_calls }}</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Billing History -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-transparent border-0">
                    <h5 class="mb-0">
                        <i class="bi bi-receipt me-2"></i>
                        Billing History
                    </h5>
                </div>
                <div class="card-body">
                    {% if billing %}
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Description</th>
                                    <th>Amount</th>
                                    <th>Status</th>
                                    <th>Invoice</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for bill in billing %}
                                <tr>
                                    <td>{{ bill.date }}</td>
                                    <td>{{ bill.description }}</td>
                                    <td><span class="badge bg-success">{{ bill.amount }}</span></td>
                                    <td>
                                        <span class="badge bg-{{ 'success' if bill.status == 'Paid' else 'warning' }}">
                                            {{ bill.status }}
                                        </span>
                                    </td>
                                    <td>
                                        <a href="#" class="btn btn-sm btn-outline-primary">
                                            <i class="bi bi-download me-1"></i>
                                            {{ bill.invoice_id }}
                                        </a>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <div class="text-center py-4">
                        <i class="bi bi-receipt text-muted" style="font-size: 3rem;"></i>
                        <h5 class="mt-3 text-muted">No billing history</h5>
                        <p class="text-muted">Your billing history will appear here once you have active subscriptions.</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Plan Comparison -->
    <div class="row">
        <div class="col-12">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-transparent border-0">
                    <h5 class="mb-0">
                        <i class="bi bi-bar-chart me-2"></i>
                        Plan Comparison
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="card h-100 border-2 {{ 'border-primary' if not subscription.is_premium else 'border-secondary' }}">
                                <div class="card-header text-center bg-light">
                                    <h5 class="mb-0">Free Plan</h5>
                                    <h3 class="text-primary mb-0">$0/month</h3>
                                </div>
                                <div class="card-body">
                                    <ul class="list-unstyled">
                                        <li class="mb-2"><i class="bi bi-check text-success me-2"></i>3 Resumes</li>
                                        <li class="mb-2"><i class="bi bi-check text-success me-2"></i>Basic Templates</li>
                                        <li class="mb-2"><i class="bi bi-check text-success me-2"></i>PDF Export</li>
                                        <li class="mb-2"><i class="bi bi-check text-success me-2"></i>Email Support</li>
                                        <li class="mb-2"><i class="bi bi-check text-success me-2"></i>Basic Analytics</li>
                                        <li class="mb-2 text-muted"><i class="bi bi-x text-muted me-2"></i>Advanced AI Analysis</li>
                                        <li class="mb-2 text-muted"><i class="bi bi-x text-muted me-2"></i>Priority Support</li>
                                        <li class="mb-2 text-muted"><i class="bi bi-x text-muted me-2"></i>Team Collaboration</li>
                                    </ul>
                                </div>
                                <div class="card-footer bg-transparent">
                                    {% if not subscription.is_premium %}
                                    <div class="d-grid">
                                        <span class="btn btn-outline-secondary">Current Plan</span>
                                    </div>
                                    {% else %}
                                    <div class="d-grid">
                                        <button class="btn btn-outline-secondary" onclick="downgradePlan()">Downgrade</button>
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-6">
                            <div class="card h-100 border-2 {{ 'border-primary' if subscription.is_premium else 'border-secondary' }}">
                                <div class="card-header text-center bg-primary text-white">
                                    <h5 class="mb-0">Premium Plan</h5>
                                    <h3 class="mb-0">$19.99/month</h3>
                                    <small>Save 20% with annual billing</small>
                                </div>
                                <div class="card-body">
                                    <ul class="list-unstyled">
                                        <li class="mb-2"><i class="bi bi-check text-success me-2"></i>Unlimited Resumes</li>
                                        <li class="mb-2"><i class="bi bi-check text-success me-2"></i>Advanced AI Analysis</li>
                                        <li class="mb-2"><i class="bi bi-check text-success me-2"></i>Priority Support</li>
                                        <li class="mb-2"><i class="bi bi-check text-success me-2"></i>Custom Templates</li>
                                        <li class="mb-2"><i class="bi bi-check text-success me-2"></i>Export to Multiple Formats</li>
                                        <li class="mb-2"><i class="bi bi-check text-success me-2"></i>Advanced Analytics</li>
                                        <li class="mb-2"><i class="bi bi-check text-success me-2"></i>Team Collaboration</li>
                                        <li class="mb-2"><i class="bi bi-check text-success me-2"></i>API Access</li>
                                    </ul>
                                </div>
                                <div class="card-footer bg-transparent">
                                    {% if subscription.is_premium %}
                                    <div class="d-grid">
                                        <span class="btn btn-primary">Current Plan</span>
                                    </div>
                                    {% else %}
                                    <div class="d-grid">
                                        <button class="btn btn-primary" onclick="upgradePlan()">Upgrade Now</button>
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Upgrade Modal -->
<div class="modal fade" id="upgradeModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Upgrade to Premium</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label">Select Billing Cycle:</label>
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="billingCycle" id="monthly" value="monthly" checked>
                        <label class="form-check-label" for="monthly">
                            Monthly - $19.99/month
                        </label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="billingCycle" id="yearly" value="yearly">
                        <label class="form-check-label" for="yearly">
                            Yearly - $199.99/year (Save 20%)
                        </label>
                    </div>
                </div>
                <div class="alert alert-info">
                    <i class="bi bi-info-circle me-2"></i>
                    You'll be redirected to our secure payment processor to complete your upgrade.
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="processUpgrade()">
                    <i class="bi bi-credit-card me-2"></i>
                    Proceed to Payment
                </button>
            </div>
        </div>
    </div>
</div>

<style>
.metric-highlight {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border-radius: 10px;
    padding: 1.5rem;
    text-align: center;
}

.metric-value {
    font-size: 2.5rem;
    font-weight: bold;
    margin-bottom: 0.5rem;
}

.metric-label {
    font-size: 0.9rem;
    opacity: 0.9;
}

.plan-card {
    transition: transform 0.2s ease-in-out;
}

.plan-card:hover {
    transform: translateY(-5px);
}
</style>

<script>
function upgradePlan() {
    const modal = new bootstrap.Modal(document.getElementById('upgradeModal'));
    modal.show();
}

async function processUpgrade() {
    const billingCycle = document.querySelector('input[name="billingCycle"]:checked').value;
    
    try {
        showLoading(document.querySelector('#upgradeModal .btn-primary'));
        
        const response = await fetch('/api/upgrade-plan', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                plan: billingCycle
            })
        });
        
        const data = await response.json();
        
        if (data.success) {
            // Redirect to Stripe checkout
            window.location.href = data.checkout_url;
        } else {
            showToast('Failed to create checkout session', 'error');
        }
        
    } catch (error) {
        console.error('Error processing upgrade:', error);
        showToast('Failed to process upgrade', 'error');
    } finally {
        hideLoading(document.querySelector('#upgradeModal .btn-primary'));
    }
}

async function cancelSubscription() {
    if (!confirm('Are you sure you want to cancel your subscription? You will lose access to premium features at the end of your current billing period.')) {
        return;
    }
    
    try {
        const response = await fetch('/api/cancel-subscription', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        });
        
        const data = await response.json();
        
        if (data.success) {
            showToast('Subscription cancelled successfully', 'success');
            setTimeout(() => {
                window.location.reload();
            }, 2000);
        } else {
            showToast('Failed to cancel subscription', 'error');
        }
        
    } catch (error) {
        console.error('Error cancelling subscription:', error);
        showToast('Failed to cancel subscription', 'error');
    }
}

function downgradePlan() {
    if (confirm('Are you sure you want to downgrade to the Free plan? You will lose access to premium features immediately.')) {
        cancelSubscription();
    }
}
</script>
{% endblock %}