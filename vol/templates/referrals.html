{% extends "base.html" %}

{% block title %}Referral Program{% endblock %}

{% block content %}
<div class="container py-4">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h1 class="h3 mb-0">
                    <i class="fas fa-share-alt text-primary me-2"></i>
                    Referral Program
                </h1>
                <div class="badge bg-success fs-6">
                    <i class="fas fa-coins me-1"></i>
                    Earn $5 for each referral!
                </div>
            </div>
        </div>
    </div>

    <!-- Referral Stats -->
    <div class="row mb-4">
        <div class="col-md-4 mb-3">
            <div class="card border-primary h-100">
                <div class="card-body text-center">
                    <i class="fas fa-users fa-3x text-primary mb-3"></i>
                    <h4 class="card-title">{{ total_referrals }}</h4>
                    <p class="card-text">Total Referrals</p>
                </div>
            </div>
        </div>
        <div class="col-md-4 mb-3">
            <div class="card border-success h-100">
                <div class="card-body text-center">
                    <i class="fas fa-dollar-sign fa-3x text-success mb-3"></i>
                    <h4 class="card-title">${{ earned_credits }}</h4>
                    <p class="card-text">Earned Credits</p>
                </div>
            </div>
        </div>
        <div class="col-md-4 mb-3">
            <div class="card border-warning h-100">
                <div class="card-body text-center">
                    <i class="fas fa-clock fa-3x text-warning mb-3"></i>
                    <h4 class="card-title">{{ pending_referrals|length }}</h4>
                    <p class="card-text">Pending Referrals</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Your Referral Code -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card shadow">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-qrcode me-2"></i>
                        Your Referral Code
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row align-items-center">
                        <div class="col-md-8">
                            <div class="input-group">
                                <input type="text" class="form-control form-control-lg" value="{{ referral_code }}" readonly id="referralCode">
                                <button class="btn btn-primary" type="button" onclick="copyReferralCode()">
                                    <i class="fas fa-copy me-2"></i>Copy
                                </button>
                            </div>
                            <small class="text-muted">Share this code with friends to earn rewards!</small>
                        </div>
                        <div class="col-md-4 text-center">
                            <div id="qrCode" class="mb-2"></div>
                            <button class="btn btn-outline-primary btn-sm" onclick="downloadQR()">
                                <i class="fas fa-download me-1"></i>Download QR
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- How It Works -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card shadow">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-info-circle text-info me-2"></i>
                        How It Works
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-3 text-center mb-3">
                            <div class="step-circle bg-primary text-white mb-2">
                                <i class="fas fa-share fa-2x"></i>
                            </div>
                            <h6>Share Your Code</h6>
                            <p class="text-muted">Share your referral code with friends and family</p>
                        </div>
                        <div class="col-md-3 text-center mb-3">
                            <div class="step-circle bg-success text-white mb-2">
                                <i class="fas fa-user-plus fa-2x"></i>
                            </div>
                            <h6>They Sign Up</h6>
                            <p class="text-muted">Friends use your code when creating their account</p>
                        </div>
                        <div class="col-md-3 text-center mb-3">
                            <div class="step-circle bg-warning text-white mb-2">
                                <i class="fas fa-check-circle fa-2x"></i>
                            </div>
                            <h6>They Upgrade</h6>
                            <p class="text-muted">When they upgrade to premium, you both get rewards</p>
                        </div>
                        <div class="col-md-3 text-center mb-3">
                            <div class="step-circle bg-info text-white mb-2">
                                <i class="fas fa-gift fa-2x"></i>
                            </div>
                            <h6>Earn Rewards</h6>
                            <p class="text-muted">Get $5 credit for each successful referral</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Share Options -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card shadow">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-share-alt text-primary me-2"></i>
                        Share Your Code
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <h6>Social Media</h6>
                            <div class="d-flex gap-2">
                                <button class="btn btn-primary" onclick="shareOnFacebook()">
                                    <i class="fab fa-facebook me-2"></i>Facebook
                                </button>
                                <button class="btn btn-info" onclick="shareOnTwitter()">
                                    <i class="fab fa-twitter me-2"></i>Twitter
                                </button>
                                <button class="btn btn-success" onclick="shareOnWhatsApp()">
                                    <i class="fab fa-whatsapp me-2"></i>WhatsApp
                                </button>
                            </div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <h6>Email & SMS</h6>
                            <div class="d-flex gap-2">
                                <button class="btn btn-danger" onclick="shareViaEmail()">
                                    <i class="fas fa-envelope me-2"></i>Email
                                </button>
                                <button class="btn btn-secondary" onclick="shareViaSMS()">
                                    <i class="fas fa-sms me-2"></i>SMS
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mt-3">
                        <h6>Custom Message</h6>
                        <div class="input-group">
                            <textarea class="form-control" id="customMessage" rows="3" placeholder="Write your custom referral message...">Hey! I found this amazing resume builder that helped me create a professional resume in minutes. Use my referral code {{ referral_code }} to get started and we both get rewards! ðŸš€</textarea>
                            <button class="btn btn-primary" onclick="copyCustomMessage()">
                                <i class="fas fa-copy me-2"></i>Copy Message
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Referral History -->
    <div class="row">
        <div class="col-12">
            <div class="card shadow">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-history text-secondary me-2"></i>
                        Referral History
                    </h5>
                </div>
                <div class="card-body">
                    {% if pending_referrals %}
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Friend</th>
                                    <th>Date</th>
                                    <th>Status</th>
                                    <th>Reward</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for referral in pending_referrals %}
                                <tr>
                                    <td>{{ referral.name }}</td>
                                    <td>{{ referral.date }}</td>
                                    <td>
                                        <span class="badge bg-warning">{{ referral.status }}</span>
                                    </td>
                                    <td>$5.00</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <div class="text-center py-4">
                        <i class="fas fa-users fa-3x text-muted mb-3"></i>
                        <h5 class="text-muted">No referrals yet</h5>
                        <p class="text-muted">Start sharing your referral code to earn rewards!</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.step-circle {
    width: 80px;
    height: 80px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    margin: 0 auto;
}

.gap-2 {
    gap: 0.5rem;
}
</style>

<script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
<script>
// Generate QR Code
QRCode.toCanvas(document.getElementById('qrCode'), '{{ url_for("referral_landing", code=referral_code, _external=True) }}', {
    width: 120,
    margin: 2
}, function (error) {
    if (error) console.error(error);
});

function copyReferralCode() {
    const code = document.getElementById('referralCode');
    code.select();
    code.setSelectionRange(0, 99999);
    document.execCommand('copy');
    
    // Show success message
    const btn = event.target;
    const originalText = btn.innerHTML;
    btn.innerHTML = '<i class="fas fa-check me-2"></i>Copied!';
    btn.classList.remove('btn-primary');
    btn.classList.add('btn-success');
    
    setTimeout(() => {
        btn.innerHTML = originalText;
        btn.classList.remove('btn-success');
        btn.classList.add('btn-primary');
    }, 2000);
}

function copyCustomMessage() {
    const message = document.getElementById('customMessage');
    message.select();
    message.setSelectionRange(0, 99999);
    document.execCommand('copy');
    
    // Show success message
    const btn = event.target;
    const originalText = btn.innerHTML;
    btn.innerHTML = '<i class="fas fa-check me-2"></i>Copied!';
    btn.classList.remove('btn-primary');
    btn.classList.add('btn-success');
    
    setTimeout(() => {
        btn.innerHTML = originalText;
        btn.classList.remove('btn-success');
        btn.classList.add('btn-primary');
    }, 2000);
}

function shareOnFacebook() {
    const url = encodeURIComponent('{{ url_for("referral_landing", code=referral_code, _external=True) }}');
    const text = encodeURIComponent(document.getElementById('customMessage').value);
    window.open(`https://www.facebook.com/sharer/sharer.php?u=${url}&quote=${text}`, '_blank');
}

function shareOnTwitter() {
    const url = encodeURIComponent('{{ url_for("referral_landing", code=referral_code, _external=True) }}');
    const text = encodeURIComponent(document.getElementById('customMessage').value);
    window.open(`https://twitter.com/intent/tweet?url=${url}&text=${text}`, '_blank');
}

function shareOnWhatsApp() {
    const url = encodeURIComponent('{{ url_for("referral_landing", code=referral_code, _external=True) }}');
    const text = encodeURIComponent(document.getElementById('customMessage').value);
    window.open(`https://wa.me/?text=${text}%20${url}`, '_blank');
}

function shareViaEmail() {
    const url = '{{ url_for("referral_landing", code=referral_code, _external=True) }}';
    const text = document.getElementById('customMessage').value;
    const subject = encodeURIComponent('Amazing Resume Builder - Check it out!');
    const body = encodeURIComponent(`${text}\n\n${url}`);
    window.open(`mailto:?subject=${subject}&body=${body}`, '_blank');
}

function shareViaSMS() {
    const url = '{{ url_for("referral_landing", code=referral_code, _external=True) }}';
    const text = document.getElementById('customMessage').value;
    const body = encodeURIComponent(`${text}\n\n${url}`);
    window.open(`sms:?body=${body}`, '_blank');
}

function downloadQR() {
    const canvas = document.querySelector('#qrCode canvas');
    const link = document.createElement('a');
    link.download = 'referral-qr.png';
    link.href = canvas.toDataURL();
    link.click();
}
</script>
{% endblock %} 